## 一、Mysql的 AKF 立方体

用 AKF 理解下 mysql为了确保数据库的高可用性在处理海量数据的时是如何实现的

![image-20241123234031462](/Users/gaoqisen/Library/Application Support/typora-user-images/image-20241123234031462.png)

X 轴：为了解决单点故障，mysql 可以用 **主从复制** 等方式进行副本扩展，这样在其中一台机器出现故障时。其他的机器也能正常提供服务

Y 轴：可以理解为数据的垂直拆分，比如当数据量太大的时候，单表的数据列太多，可以将表拆分为多张表。也可以将数据进行 **分库** 比如用户库、订单库等，这样可以避免单点故障用户库出现问题后订单库还是能提供服务的。

Z轴: 可以理解为数据的水平拆分，比如用户库里面的用户数据太多，单表查询很慢可以进行用户 ID 的取模 **分表** 操作，这种分表操作就是分区的效果（100 w的数据模 10，就是将数据分为 10 份每份 10w 的数据分区）。

上面每个轴的具体实现方式各有不同，关键点就是副本的扩展和分库分表。副本的扩展要考虑副本之间的数据如何同步，扩展的时候出现单点故障如何恢复等问题，下面先了解下副本扩展的各种架构演进

### 1.2 高可用

常见的高可用架构方案，每种架构都是遇到问题后慢慢演进出来的，下面通过时间和版本梳理下。

| 架构方式                                                     | 年份       | 版本    | 解决问题                                           |
| :----------------------------------------------------------- | ---------- | ------- | -------------------------------------------------- |
| 主从复制架构（Master - Slave Replication）                   | 1999       | 3.23   | 官方提供的防止数据丢失、读写分离                             |
| 双主复制架构（Dual - Master Replication）                    | 2005          |5.0      | 官方提供的双向数据同步，异地容灾                             |
| 主主复制管理 MMM(Master-Master replication manager) | 2007～2008 | 5.0+ | Open Query公司开发的简化主主复制故障切换、提高可用性                   |
| 集群高可用 MHA<br />（MySQL Master High Availability）       | 2010～2011 | 5.1+    | Yahoo公司开发的减少切换主从速度、自动修复复制关系                 |
| 半同步（半同步Semisynchronous replication）                       |   2010       |     5.5+    |   官方数据一致性要求高                                 |
| ProxySql + 主从复制                                          |      2013      |    5.6+     |     ProxySQL开源社区提供的通过中间件实现读写分离和负载均衡                       |
| 分片 + 高可用                                                |      2013      |     5.6+    |     Google、Facebook等海量数据存储+超大规模系统                                               |
| Mysql组复制 MGR（MySQL Group Replication）                   | 2016       | 5.7.17+    | 官方实现Paxos 保证数据一致性、高可用和自动故障处理 |
| InnoDB Cluster                                               |   2016         |  8.0+      | 官方一站式高可用方案                                                   |

各种架构的优缺点分析

| 架构方式        | 优点 | 缺点 | 原理 |
| :-------------- | ---- | ---- | ---- |
| 主从复制架构MSR |  简单易用，提供读写分离    | 单点故障风险高     |  主节点写入binlog日志，从节点同步数据    |
| 双主复制架构 | 双主互相备份，实现高可用（不建议使用） | 写入冲突更新丢失，切换复杂 | 两个主节点互相写入数据，互相复制对方的变更     |
| 主主复制管理MMM |  主主复制，避免单点故障  | 部署维护复杂 |  通过监视复制延迟实现自动故障切换    |
| 集群高可用 MHA |   主从自动化故障切换，快速故障恢复   |   部署和配置复杂   |   监控主节点状态和健康实现自动故障切换   |
| 半同步   |   提供更高的数据一致性和可靠性   |  对网络延迟敏感    |   写入数据需要执至少一个从节点收到数据后提交事务   |
| ProxySql + 主从复制  |  提供负载均衡和故障转移    |   需要额外的中间件，增加复杂性   |   代理层进行路由监控节点状态实现故障转移   |
| 分片 + 高可用   |   实现水平扩展，适用大规模数据   | 部署和管理复杂     |  数据进行水平分片后+MHA    |
| Mysql组复制MGR  |   提供高可用+数据一致性，支持自动故障转移   | 部署管理复杂     |  多个数据库节点形成组，通过组复制协议实现同步和故障处理    |
| InnoDB Cluster  |  集成高可用和灾难恢复方案，支持自动化管理和监控    |  需要MysqlRouter，引入额外组件    |  使用Mysql Shell+Group Replication组件实现自动故障转移、数据同步和管理，基于binlog和组复制协议实现高可用    |

主从复制

![image](https://gaoqisen.github.io/GraphBed/202411/20241127225955.png)

MMM

![MMM](https://gaoqisen.github.io/GraphBed/202411/20241127232754.png)

MHA

![MHA](https://gaoqisen.github.io/GraphBed/202411/20241127232950.png)

半同步

![半同步](https://gaoqisen.github.io/GraphBed/202411/20241127233636.png)

MHA+半同步

![](https://gaoqisen.github.io/GraphBed/202411/20241127234122.png)

MGR

![MGR](https://gaoqisen.github.io/GraphBed/202411/20241127234718.png)

InnoDB Cluster

![](https://gaoqisen.github.io/GraphBed/202411/20241127235148.png)

### 1.2 分库分表



## 二、Mysql 语句执行过程



### 2.1 查询语句



### 2.2 增删改语句



## 三、事务

MVCC



Buffer Pool、自适应Hash索引、双写缓冲区。

## 四、查询语句优化

索引

索引失效

执行计划

成本计算

